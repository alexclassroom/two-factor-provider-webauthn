!function(e,n){function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=t(e);function r(){return r=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},r.apply(this,arguments)}n.__("WebAuthn is not supported by the browser.","2fa-wa-js"),n.__("Unable to get a public key credential.","2fa-wa-js");var i=n.__("The request is not allowed.","2fa-wa-js"),o=n.__("The operation is insecure.","2fa-wa-js"),s=n.__("The operation is not supported.","2fa-wa-js"),c=n.__("The operation was canceled.","2fa-wa-js"),d=n.__("You cannot use this key to log in.","2fa-wa-js"),u=n.__("This key is already registered.","2fa-wa-js"),l=n.__("This key is already registered.","2fa-wa-js"),f=n.__("Fetching registration information…","2fa-wa-js"),y=n.__("Generating credentials…","2fa-wa-js"),h=n.__("Registering credentials…","2fa-wa-js"),v=n.__("Unable to create public key credentials","2fa-wa-js"),w=n.__("The key has been registered.","2fa-wa-js"),p=n.__("Sending request…","2fa-wa-js"),_=n.__("The key has been revoked.","2fa-wa-js"),b=n.__("The key has been renamed.","2fa-wa-js");function k(e){return window.btoa(String.fromCharCode.apply(String,e))}function m(e){return window.atob(e.replace(/-/g,"+").replace(/_/g,"/")+"=".repeat(3-(3+e.length)%4))}function g(e){return"TextEncoder"in window?(new TextEncoder).encode(e):Uint8Array.from(e,(function(e){return e.charCodeAt(0)}))}function x(e){return new Promise((function(n,t){a.default.ajax({method:"POST",url:ajaxurl,data:e}).done((function(e){n(e)})).fail((function(e){var n;n=e.responseJSON?e.responseJSON.data||l:e.statusText,t(new Error(n))}))}))}a.default((function(e){var n=e("#webauthn-security-keys-section");function t(e){e?n.find(".security-key-status").html('<div class="notice notice-info inline"><p>'+e+"</p></div>"):n.find(".security-key-status").text("")}function a(e){var t=e instanceof DOMException?function(e,n){switch(e.name){case"NotAllowedError":return i;case"SecurityError":return o;case"NotSupportedError":return s;case"AbortError":return c;case"InvalidStateError":return n?d:u;default:return e.message}}(e,!1):e.message,a=n.find(".registered-keys");a.siblings(".notice").remove(),a.before('<div class="notice notice-error inline" role="alert"><p>'+t+"</p></div>")}n.find(".add-webauthn-key button").on("click",(function(){n.find(".registered-keys").prev(".notice").remove(),t(f),x({action:"webauthn_preregister",_ajax_nonce:tfa_webauthn.nonce}).then((function(e){t(y),tfa_webauthn.nonce=e.data.nonce;var n=function(e){var n;return r({},e,{user:r({},e.user,{id:g(m(e.user.id))}),challenge:g(m(e.challenge)),excludeCredentials:null===(n=e.excludeCredentials)||void 0===n?void 0:n.map((function(e){return r({},e,{id:g(m(e.id))})}))})}(e.data.options);return navigator.credentials.create({publicKey:n})})).then((function(n){if(n){t(h);var a=e("#webauthn-key-name").val();return x({action:"webauthn_register",_ajax_nonce:tfa_webauthn.nonce,credential:JSON.stringify((r=n,i=r.response,{id:r.id,type:r.type,rawId:k(new Uint8Array(r.rawId)),clientExtensionResults:r.getClientExtensionResults(),response:{attestationObject:"attestationObject"in i?k(new Uint8Array(i.attestationObject)):void 0,authenticatorData:"authenticatorData"in i?k(new Uint8Array(i.authenticatorData)):void 0,signature:"signature"in i?k(new Uint8Array(i.signature)):void 0,userHandle:"userHandle"in i&&i.userHandle?k(new Uint8Array(i.userHandle)):void 0,clientDataJSON:k(new Uint8Array(r.response.clientDataJSON))}})),name:a})}var r,i;throw new Error(v)})).then((function(e){tfa_webauthn.nonce=e.data.nonce;var t=n.find(".registered-keys");t.find("tbody > tr:last-child").after(e.data.row),t.find("tbody > tr.no-items").remove(),t.before('<div class="notice notice-success inline" role="alert"><p>'+w+"</p></div>")})).catch(a).finally((function(){t(""),e("#webauthn-key-name").val("")}))})),n.find(".registered-keys").on("click","tbody .delete a",(function(r){n.find(".registered-keys").prev(".notice").remove(),r.preventDefault();var i=e(r.target),o=i.closest(".row-actions");if(!o.next(".confirm-revoke").length){var s=i.data("handle"),c=i.data("nonce"),d=n.find(".registered-keys"),u=e(e("#webauthn-revoke-confirm").text());o.after(u),o.next(".confirm-revoke").on("click",".button-secondary",(function(){o.next(".confirm-revoke").remove()})).on("click",".button-link-delete",(function(){return o.next(".confirm-revoke").hide(),t(p),x({action:"webauthn_delete_key",_ajax_nonce:c,handle:s}).then((function(){d.before('<div class="notice notice-success inline" role="alert"><p>'+_+"</p></div>"),i.closest("tr").remove(),d.find("tbody > tr").length||d.find("tbody").append(e("#webauthn-no-keys").text())})).catch(a).finally((function(){t(""),o.next(".confirm-revoke").remove()}))}))}})),n.find(".registered-keys").on("click","tbody .rename a",(function(r){n.find(".registered-keys").prev(".notice").remove(),r.preventDefault();var i=e(r.target),o=i.closest(".row-actions");if(!o.next(".rename-key").length){var s=i.data("handle"),c=i.data("nonce"),d=i.closest("td").find("span.key-name").text().trim(),u=n.find(".registered-keys"),l=e(e("#webauthn-rename-key").text());o.after(l),o.next(".rename-key").on("click",".button-secondary",(function(){o.next(".rename-key").remove()})).on("click",".button-primary",(function(){var e=o.next(".rename-key").find('input[type="text"]').val();return o.next(".rename-key").hide(),t(p),x({action:"webauthn_rename_key",_ajax_nonce:c,handle:s,name:e}).then((function(e){u.before('<div class="notice notice-success inline" role="alert"><p>'+b+"</p></div>"),i.closest("td").find("span.key-name").text(e.data.name)})).catch(a).finally((function(){t(""),o.next(".rename-key").remove()}))})).find('input[type="text"]').val(d)}}))}))}(jQuery,wp.i18n);
