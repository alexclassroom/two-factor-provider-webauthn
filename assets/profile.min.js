!function(e,t){function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=n(e);function a(){return a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},a.apply(this,arguments)}t.__("WebAuthn is not supported by the browser.","two-factor-provider-webauthn"),t.__("Unable to get a public key credential.","two-factor-provider-webauthn");var o=t.__("The request is not allowed.","two-factor-provider-webauthn"),i=t.__("The operation is insecure.","two-factor-provider-webauthn"),c=t.__("The operation is not supported.","two-factor-provider-webauthn"),s=t.__("The operation was canceled.","two-factor-provider-webauthn"),d=t.__("You cannot use this key to log in.","two-factor-provider-webauthn"),u=t.__("This key is already registered.","two-factor-provider-webauthn"),l=t.__("This key is already registered.","two-factor-provider-webauthn"),f=t.__("Fetching registration information…","two-factor-provider-webauthn"),h=t.__("Generating credentials…","two-factor-provider-webauthn"),v=t.__("Registering credentials…","two-factor-provider-webauthn"),p=t.__("Unable to create public key credentials","two-factor-provider-webauthn"),w=t.__("The key has been registered.","two-factor-provider-webauthn"),y=t.__("Sending request…","two-factor-provider-webauthn"),b=t.__("The key has been revoked.","two-factor-provider-webauthn"),_=t.__("The key has been renamed.","two-factor-provider-webauthn");function k(e){return window.btoa(String.fromCharCode.apply(String,e))}function m(e){return window.atob(e.replace(/-/g,"+").replace(/_/g,"/")+"=".repeat(3-(3+e.length)%4))}function g(e){return Uint8Array.from(e,(function(e){return e.charCodeAt(0)}))}function x(e){return new Promise((function(t,n){r.default.ajax({method:"POST",url:ajaxurl,data:e}).done((function(e){t(e)})).fail((function(e){var t;t=e.responseJSON?e.responseJSON.data||l:e.statusText,n(new Error(t))}))}))}r.default((function(e){var t=e("#webauthn-security-keys-section");function n(e){e?t.find(".security-key-status").html('<div class="notice notice-info inline"><p>'+e+"</p></div>"):t.find(".security-key-status").text("")}function r(e){var n=e instanceof DOMException?function(e,t){switch(e.name){case"NotAllowedError":return o;case"SecurityError":return i;case"NotSupportedError":return c;case"AbortError":return s;case"InvalidStateError":return t?d:u;default:return e.message}}(e,!1):e.message,r=t.find(".registered-keys");r.siblings(".notice").remove(),r.before('<div class="notice notice-error inline" role="alert"><p>'+n+"</p></div>")}t.find(".add-webauthn-key button").on("click",(function(){t.find(".registered-keys").prev(".notice").remove(),n(f),x({action:"webauthn_preregister",_ajax_nonce:tfa_webauthn.nonce}).then((function(e){n(h),tfa_webauthn.nonce=e.data.nonce;var t=function(e){var t;return a({},e,{user:a({},e.user,{id:g(m(e.user.id))}),challenge:g(m(e.challenge)),excludeCredentials:null===(t=e.excludeCredentials)||void 0===t?void 0:t.map((function(e){return a({},e,{id:g(m(e.id))})}))})}(e.data.options);return navigator.credentials.create({publicKey:t})})).then((function(t){if(t){n(v);var r=e("#webauthn-key-name").val();return x({action:"webauthn_register",_ajax_nonce:tfa_webauthn.nonce,credential:JSON.stringify((a=t,o=a.response,{id:a.id,type:a.type,rawId:k(new Uint8Array(a.rawId)),clientExtensionResults:a.getClientExtensionResults(),response:{attestationObject:"attestationObject"in o?k(new Uint8Array(o.attestationObject)):void 0,authenticatorData:"authenticatorData"in o?k(new Uint8Array(o.authenticatorData)):void 0,signature:"signature"in o?k(new Uint8Array(o.signature)):void 0,userHandle:"userHandle"in o&&o.userHandle?k(new Uint8Array(o.userHandle)):void 0,clientDataJSON:k(new Uint8Array(a.response.clientDataJSON))}})),name:r})}var a,o;throw new Error(p)})).then((function(e){tfa_webauthn.nonce=e.data.nonce;var n=t.find(".registered-keys");n.find("tbody > tr:last-child").after(e.data.row),n.find("tbody > tr.no-items").remove(),n.before('<div class="notice notice-success inline" role="alert"><p>'+w+"</p></div>")})).catch(r).finally((function(){n(""),e("#webauthn-key-name").val("")}))})),t.find(".registered-keys").on("click","tbody .delete a",(function(a){t.find(".registered-keys").prev(".notice").remove(),a.preventDefault();var o=e(a.target),i=o.closest(".row-actions");if(!i.next(".confirm-revoke").length){var c=o.data("handle"),s=o.data("nonce"),d=t.find(".registered-keys"),u=e(e("#webauthn-revoke-confirm").text());i.after(u),i.next(".confirm-revoke").on("click",".button-secondary",(function(){i.next(".confirm-revoke").remove()})).on("click",".button-link-delete",(function(){return i.next(".confirm-revoke").hide(),n(y),x({action:"webauthn_delete_key",_ajax_nonce:s,handle:c}).then((function(){d.before('<div class="notice notice-success inline" role="alert"><p>'+b+"</p></div>"),o.closest("tr").remove(),d.find("tbody > tr").length||d.find("tbody").append(e("#webauthn-no-keys").text())})).catch(r).finally((function(){n(""),i.next(".confirm-revoke").remove()}))}))}})),t.find(".registered-keys").on("click","tbody .rename a",(function(a){t.find(".registered-keys").prev(".notice").remove(),a.preventDefault();var o=e(a.target),i=o.closest(".row-actions");if(!i.next(".rename-key").length){var c=o.data("handle"),s=o.data("nonce"),d=o.closest("td").find("span.key-name").text().trim(),u=t.find(".registered-keys"),l=e(e("#webauthn-rename-key").text());i.after(l),i.next(".rename-key").on("click",".button-secondary",(function(){i.next(".rename-key").remove()})).on("click",".button-primary",(function(){var e=i.next(".rename-key").find('input[type="text"]').val();return i.next(".rename-key").hide(),n(y),x({action:"webauthn_rename_key",_ajax_nonce:s,handle:c,name:e}).then((function(e){u.before('<div class="notice notice-success inline" role="alert"><p>'+_+"</p></div>"),o.closest("td").find("span.key-name").text(e.data.name)})).catch(r).finally((function(){n(""),i.next(".rename-key").remove()}))})).find('input[type="text"]').val(d)}}))}))}(jQuery,wp.i18n);
